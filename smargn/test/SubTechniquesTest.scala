import org.apache.spark.rdd.RDD
import org.apache.spark.{SparkConf, SparkContext}
import org.scalatest.ShouldMatchers
import techniques.NaiveShiftComparison._
import techniques.NaiveInverseComparisons._
import techniques.Divergence._

class SubTechniquesTest extends SparkTestUtils with ShouldMatchers {

  val summedWordPerYear = Array(2122323, 2244681, 2090514, 2065231, 1977265, 2024515, 1930356, 2277546, 1999820, 2101924, 2697558, 3219945, 3159865, 3001991, 3400445, 3424123, 4755786, 4865075, 4890963, 4452536, 4757160, 4888676, 5692283, 6336701, 6595610, 5955054, 5799465, 5856907, 6429359, 6592246, 7391701, 7861885, 8147593, 8025362, 7718126, 8325643, 6853073, 8364891, 8396568, 8230138, 8355511, 8645025, 8120658, 8517314, 8198095, 7992581, 7885120, 8209978, 8176737, 8018662, 8109653, 9393429, 9391806, 9849588, 9820476, 9699829, 10320342, 10109845, 10712237, 11274764, 11262049, 11405377, 11331632, 11187626, 10673355, 10257862, 10730687, 11474657, 11289690, 11224426, 11931212, 11809556, 12166655, 12845947, 11197905, 10440220, 11512458, 4769483, 4131755, 4767862, 8276512, 10789993, 11370154, 12221120, 11976838, 12744341, 13118419, 12679902, 12830140, 13786786, 14661115, 13426685, 13290765, 13276314, 13641513, 13557697, 10497287, 13805143, 12954176, 11950092, 9769621, 10601749, 12018854, 11715157, 12542519, 11883999, 13560945, 12045927, 13016994, 13299083, 13498171, 12699478, 13179157, 13659607, 14406374, 14006581, 13517493, 14822764, 14638583, 14626616, 16248005, 16847006, 16681617, 16555457, 18025636, 15627347, 18112566, 16430876, 14775628, 16012264, 16658242, 14676114, 13569468, 15397707, 14594267, 14970719, 14062956, 13471200, 18348500, 17082730, 16321588, 17267341, 19114344, 18872176, 20156965, 21053925, 45482968, 49240500, 47060830, 20575469, 20826940, 84016140, 185138460, 49190342, 79628120, 79902604, 130423848, 182917206, 4967354)

  def normalizerForTests(data: Array[(String, Array[Double])]): Array[(String, Array[Double])] = {
    val data2 = data.map(x => (x._1, x._2.zip(summedWordPerYear).map(x => x._1 / x._2.toDouble)))
    data2
  }

  sparkTest("testNaiveInverseComparisons1") {
    val testedWord = ("sky", Array(2.0, 3.0, 4.0, 12.0, 3.0))
    val dataRaw = Array(("sea", Array(3.0, 11.0, 3.0, 2.0, 1.0)), ("earth", Array(3.0, 12.0, 4.0, 3.0, 2.0)), ("yellow", Array(13.0, 14.0, 13.0, 16.0, 15.0)), ("flower", Array(14.0, 15.0, 16.0, 114.0, 15.0)))
    val data = sc.parallelize(dataRaw)
    val b = naiveInverseDifference(data, testedWord, List(2.0))
    b.collect().sortWith(_ < _) should be(Array("earth", "sea"))
  }

  sparkTest("testNaiveInverseComparisons2") {
    val testedWord = ("sky", Array(12.0, 13.0, 14.0, 112.0, 13.0))
    val dataRaw = Array(("sea", Array(1.0, 2.0, 3.0, 4.0, 5.0)), ("earth", Array(2.0, 1.0, 2.0, 4.0, 4.0)), ("yellow", Array(3.0, 4.0, 3.0, 6.0, 5.0)), ("flower", Array(4.0, 5.0, 6.0, 14.0, 5.0)), ("orange", Array(1.0, 5.0, 6.0, 13.0, 2.0)), ("dummy", Array(20.0, 30.0, 4.0, 2.0, 3.0)), ("parrot", Array(2.0, 3.0, 4.0, 12.0, 3.0)))
    val data = sc.parallelize(dataRaw)
    naiveInverseDifference(data, testedWord, List(0.2)).collect().sortWith(_ < _) should be(Array())
  }

  // SHIFT TEST BASED ON VALUE SHIFTLEN = 3, SHIFTSTEP = 1
  sparkTest("NaiveShiftComparison1") {
    val testedWord = ("word1", Array(2.0, 1.0, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0))
    val dataRaw = Array(("sea", Array(5.0, 4.0, 3.0, 2.0, 1.0, 0.0, 1.0, 2.0, 3.0)), ("boring", Array(15.0, 16.0, 71.0, 8.0, 19.0, 10.0, 11.0, 12.0, 13.0)))
    val data = sc.parallelize(dataRaw)
    naiveDifferenceShift(data, testedWord, List(0.2)).collect().sortWith(_ < _) should be(Array("sea"))
  }

  sparkTest("NaiveShiftComparison2") {
    val testedWord = ("word1", Array(2.0, 1.0, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0))
    val dataRaw = Array(("sea", Array(10.0, 5.0, 4.0, 3.0, 2.0, 1.0, 0.0, 1.0, 2.0)), ("boring", Array(5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0)))
    val data = sc.parallelize(dataRaw)
    naiveDifferenceShift(data, testedWord, List(0.2)).collect().sortWith(_ < _) should be(Array())
  }

  sparkTest("NaiveShiftComparison3") {
    val testedWord = ("word1", Array(2.0, 1.0, 0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0))
    val dataRaw = Array(("sea", Array(15.0, 14.0, 13.0, 12.0, 11.0, 10.0, 11.0, 12.0, 13.0)), ("boring", Array(5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0)))
    val data = sc.parallelize(dataRaw)
    naiveDifferenceShift(data, testedWord, List(0.2)).collect().sortWith(_ < _) should be(Array())
  }

  sparkTest("testDivergence1") {
    val testedWord = ("word1", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 5.0, 7.0, 9.0, 20.0, 23.0))
    val dataRaw = Array(("sea", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 2.0, 2.0, 10.0, 0.0)))
    val data = sc.parallelize(dataRaw)
    naiveDifferenceDivergence(data, testedWord, List(1.0, 3.0, 3.0)).collect().sortWith(_ < _) should be(Array("sea"))
  }

  sparkTest("testDivergence2") {
    val testedWord = ("word1", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 5.0, 7.0, 9.0, 20.0, 23.0))
    val dataRaw = Array(("sea", Array(2.0, 4.0, 2.0, 3.0, 2.0, 2.0, 5.0, 2.0, 2.0, 10.0, 0.0)))
    val data = sc.parallelize(dataRaw)
    naiveDifferenceDivergence(data, testedWord, List(1.0, 3.0, 3.0)).collect().sortWith(_ < _) should be(Array("sea"))
  }

  // Here we would expect an empty array because we have two value in sea that differ form the word1. But the two curves
  // do not diverge
  sparkTest("testDivergence3") {
    val testedWord = ("word1", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 5.0, 7.0, 9.0, 20.0, 23.0))
    val dataRaw = Array(("sea", Array(3.0, 3.0, 3.0, 3.0, 3.0, 2.0, 5.0, 2.0, 2.0, 19.0, 23.0)))
    val data = sc.parallelize(dataRaw)
    naiveDifferenceDivergence(data, testedWord, List(1.0, 3.0, 3.0)).collect().sortWith(_ < _) should be(Array())
  }

  sparkTest("testDivergence4") {
    val testedWord = ("word1", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 5.0, 7.0, 9.0, 20.0, 23.0))
    val dataRaw = Array(("sea", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 2.0, 2.0, 10.0, 0.0)), ("sky", Array(13.0, 23.0, 33.0, 33.0, 0.0, 30.0, 0.0, 2.0, 2.0, 1.0, 0.0)), ("cloud", Array(3.0, 3.0, 3.0, 3.0, 3.0, 0.0, 0.0, 2.0, 2.0, 10.0, 0.0)))
    val data = sc.parallelize(dataRaw)
    naiveDifferenceDivergence(data, testedWord, List(1.0, 3.0, 3.0)).collect().sortWith(_ < _) should be(Array("cloud", "sea"))
  }


  sparkTest("testDivergenceInverse1") {
    val testedWord = ("montagne", Array(147, 128, 88, 125, 97, 85, 66, 77, 54, 124, 272, 422, 93, 117, 117, 125, 286, 235, 244, 174, 242, 253, 332, 253, 270, 309, 277, 268, 432, 327, 255, 295, 377, 293, 390, 423, 317, 483, 332, 334, 342, 518, 419, 387, 394, 445, 364, 545, 439, 415, 463, 494, 612, 616, 783, 784, 759, 861, 742, 794, 860, 929, 958, 1051, 1301, 1007, 1111, 1173, 1113, 1232, 1424, 1445, 1592, 1776, 1080, 1289, 1147, 318, 260, 206, 390, 651, 682, 775, 909, 1090, 1340, 975, 1271, 1151, 1187, 1003, 1052, 1286, 1363, 1411, 1099, 1422, 1345, 1184, 976, 1117, 1446, 1204, 1250, 694, 1211, 869, 914, 1046, 1166, 1047, 1313, 1246, 1346, 1361, 1480, 1570, 1224, 1330, 1313, 1515, 1781, 1358, 1212, 1143, 1847, 1363, 1281, 1394, 1595, 1160, 1063, 1384, 1367, 1161, 1235, 1063, 1758, 1349, 1204, 1291, 1423, 1719, 1695, 1933, 3402, 3946, 4042, 1619, 1615, 6322, 13866, 3514, 5516, 5860, 10119, 12312, 280).map(x => x.toDouble))
    val dataRaw = Array(("nationales", Array(47, 32, 36, 42, 46, 28, 51, 52, 87, 43, 50, 53, 66, 41, 53, 63, 65, 61, 77, 101, 117, 152, 123, 114, 113, 118, 171, 187, 120, 163, 240, 349, 183, 195, 181, 170, 185, 132, 173, 170, 197, 195, 170, 158, 110, 170, 135, 183, 157, 148, 130, 248, 215, 243, 203, 219, 284, 261, 217, 214, 205, 235, 207, 214, 189, 220, 197, 297, 247, 244, 268, 296, 321, 331, 289, 454, 471, 194, 179, 279, 358, 542, 671, 537, 575, 623, 673, 613, 589, 691, 773, 558, 657, 625, 578, 687, 760, 1190, 828, 624, 372, 372, 453, 439, 469, 469, 591, 568, 581, 649, 580, 534, 565, 628, 640, 507, 551, 647, 733, 899, 1109, 1124, 775, 983, 1285, 973, 1044, 1009, 786, 884, 968, 818, 656, 916, 823, 949, 662, 644, 1103, 838, 650, 757, 954, 989, 830, 688, 1618, 1686, 1822, 775, 781, 3384, 7008, 1786, 2330, 2952, 4353, 5946, 122).map(x => x.toDouble)), ("marche", Array(425, 447, 363, 379, 387, 379, 308, 466, 342, 366, 449, 430, 459, 417, 704, 552, 696, 733, 692, 642, 588, 581, 754, 870, 882, 781, 817, 752, 784, 759, 1611, 1188, 881, 1121, 911, 997, 891, 1400, 1167, 975, 947, 1091, 920, 925, 1084, 1132, 939, 954, 1124, 1043, 992, 1129, 1133, 1136, 1174, 1381, 1553, 1387, 1257, 1409, 2000, 1555, 1210, 1507, 1765, 1295, 1232, 1448, 1337, 1367, 1264, 1570, 1887, 1698, 1635, 1614, 1486, 507, 433, 430, 729, 923, 1017, 1143, 1161, 1157, 1272, 1246, 1496, 1526, 1528, 1242, 1341, 1355, 1500, 1543, 1063, 1377, 1381, 1247, 1315, 1156, 1175, 1165, 1298, 1202, 1123, 1078, 1148, 1229, 1269, 1057, 1180, 1071, 1250, 1469, 1353, 1558, 1537, 1444, 1687, 1519, 1396, 1644, 1488, 1297, 1465, 1223, 1284, 1344, 1212, 1168, 982, 998, 952, 1144, 997, 1079, 1427, 1331, 1360, 1574, 1548, 1495, 1632, 1555, 4118, 4058, 3558, 1571, 1678, 6996, 13896, 3440, 5098, 6036, 12027, 12366, 310).map(x => x.toDouble)))
    val data = sc.parallelize(dataRaw)
    naiveInverseDifferenceDivergence(data, testedWord, List(1.0, 3.0, 3.0)).collect().sortWith(_ < _) should be(Array("marche"))
  }

  sparkTest("testDivergenceInverse2") {
    val testedWord = ("word1", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 5.0, 7.0, 9.0, 20.0, 23.0).reverse)

    val dataRaw = Array(("sea", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 2.0, 2.0, 10.0, 0.0).reverse))
    val data = sc.parallelize(dataRaw)
    naiveInverseDifferenceDivergence(data, testedWord, List(1.0, 3.0, 3.0)).collect().sortWith(_ < _) should be(Array("sea"))
  }


  sparkTest("testDivergenceInverse3") {
    val testedWord = ("word1", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 5.0, 7.0, 9.0, 20.0, 23.0).reverse)
    val dataRaw = Array(("sea", Array(3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 2.0, 2.0, 10.0, 0.0)), ("sky", Array(13.0, 23.0, 33.0, 33.0, 0.0, 30.0, 0.0, 2.0, 2.0, 1.0, 0.0)), ("cloud", Array(3.0, 3.0, 3.0, 3.0, 3.0, 0.0, 0.0, 2.0, 2.0, 10.0, 0.0)))
    val dataRawReversed = dataRaw.map(x => (x._1, x._2.reverse))
    val data = sc.parallelize(dataRawReversed)
    naiveInverseDifferenceDivergence(data, testedWord, List(1.0, 3.0, 3.0)).collect().sortWith(_ < _) should be(Array("cloud", "sea"))
  }

  sparkTest("testsmartDivergence1") {
    val testedWord = ("vapeur", Array(421, 491, 387, 195, 220, 187, 171, 269, 213, 250, 282, 439, 348, 459, 903, 853, 1196, 1042, 937, 597, 652, 700, 815, 710, 599, 743, 640, 651, 874, 862, 844, 911, 944, 872, 914, 838, 659, 789, 760, 644, 710, 747, 766, 1003, 806, 780, 647, 860, 699, 692, 649, 1176, 1169, 990, 994, 1061, 1013, 876, 919, 851, 957, 836, 862, 764, 1241, 885, 906, 749, 674, 746, 723, 766, 1055, 873, 1015, 1809, 2127, 701, 261, 132, 289, 289, 353, 544, 387, 550, 714, 909, 940, 958, 697, 544, 402, 352, 428, 505, 435, 792, 420, 603, 611, 535, 401, 276, 248, 212, 248, 246, 167, 228, 225, 202, 212, 198, 208, 246, 247, 318, 385, 278, 240, 213, 194, 219, 198, 180, 179, 164, 159, 154, 194, 154, 113, 182, 138, 112, 150, 121, 174, 220, 167, 228, 298, 217, 328, 312, 554, 564, 540, 190, 257, 836, 2064, 408, 808, 496, 732, 1056, 30).map(x => x.toDouble))
    val testedWordNorm = normalizerForTests(Array(testedWord)).head
    val mustNotMatchNorm = ("mustNotMATCH", testedWord._2.map(x => x - 150.0))
    val dataRaw = Array(("nationales", Array(47, 32, 36, 42, 46, 28, 51, 52, 87, 43, 50, 53, 66, 41, 53, 63, 65, 61, 77, 101, 117, 152, 123, 114, 113, 118, 171, 187, 120, 163, 240, 349, 183, 195, 181, 170, 185, 132, 173, 170, 197, 195, 170, 158, 110, 170, 135, 183, 157, 148, 130, 248, 215, 243, 203, 219, 284, 261, 217, 214, 205, 235, 207, 214, 189, 220, 197, 297, 247, 244, 268, 296, 321, 331, 289, 454, 471, 194, 179, 279, 358, 542, 671, 537, 575, 623, 673, 613, 589, 691, 773, 558, 657, 625, 578, 687, 760, 1190, 828, 624, 372, 372, 453, 439, 469, 469, 591, 568, 581, 649, 580, 534, 565, 628, 640, 507, 551, 647, 733, 899, 1109, 1124, 775, 983, 1285, 973, 1044, 1009, 786, 884, 968, 818, 656, 916, 823, 949, 662, 644, 1103, 838, 650, 757, 954, 989, 830, 688, 1618, 1686, 1822, 775, 781, 3384, 7008, 1786, 2330, 2952, 4353, 5946, 122).map(x => x.toDouble)), ("marches", Array(22, 45, 31, 37, 22, 23, 25, 40, 42, 49, 34, 39, 17, 18, 50, 42, 61, 42, 74, 79, 199, 134, 70, 88, 128, 70, 91, 77, 81, 60, 158, 133, 77, 90, 91, 98, 82, 145, 100, 131, 146, 120, 102, 108, 94, 155, 101, 103, 116, 111, 87, 131, 161, 127, 150, 162, 126, 184, 124, 175, 179, 214, 208, 208, 202, 136, 133, 164, 181, 185, 178, 199, 164, 251, 245, 169, 137, 64, 54, 59, 66, 123, 97, 108, 150, 151, 138, 144, 158, 160, 216, 212, 181, 197, 210, 292, 235, 363, 316, 289, 275, 233, 245, 194, 211, 232, 261, 177, 202, 202, 230, 201, 229, 203, 221, 276, 261, 237, 232, 289, 261, 241, 254, 225, 257, 200, 272, 290, 360, 396, 241, 190, 161, 137, 153, 114, 77, 92, 163, 125, 115, 238, 391, 450, 510, 509, 1534, 1298, 1332, 417, 353, 1136, 4020, 872, 864, 838, 894, 1530, 30).map(x => x.toDouble)), ("yolo", Array(100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 1, 100, 100, 100, 100, 100, 100, 1, 100, 100, 100, 100, 100, 100, 100, 100, 1, 100, 100, 2, 1, 1, 1, 100, 100, 100, 4, 5, 100, 6, 1, 8, 100, 7, 64, 51, 52, 39, 48, 66, 222, 297, 232, 628, 554, 1129, 1201, 985, 1005, 1049, 1419, 1940, 1741, 1303, 1538, 1214, 803, 792, 587, 663, 563, 1145, 1217, 1595, 2179, 2293, 2371, 3589, 2176, 2366, 1827, 2091, 2400, 2033, 7320, 5338, 4440, 1328, 1492, 4928, 8226, 2148, 3634, 4186, 3642, 4428, 148).map(x => x.toDouble)),
      ("nucléaire", Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 2, 1, 1, 1, 0, 0, 0, 4, 5, 0, 6, 1, 8, 0, 7, 64, 51, 52, 39, 48, 66, 222, 297, 232, 628, 554, 1129, 1201, 985, 1005, 1049, 1419, 1940, 1741, 1303, 1538, 1214, 803, 792, 587, 663, 563, 1145, 1217, 1595, 2179, 2293, 2371, 3589, 2176, 2366, 1827, 2091, 2400, 2033, 7320, 5338, 4440, 1328, 1492, 4928, 8226, 2148, 3634, 4186, 3642, 4428, 148).map(x => x.toDouble)),
      mustNotMatchNorm)
    //    val dataRaw = Array(("nucléaire", Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 2, 1, 1, 1, 0, 0, 0, 4, 5, 0, 6, 1, 8, 0, 7, 64, 51, 52, 39, 48, 66, 222, 297, 232, 628, 554, 1129, 1201, 985, 1005, 1049, 1419, 1940, 1741, 1303, 1538, 1214, 803, 792, 587, 663, 563, 1145, 1217, 1595, 2179, 2293, 2371, 3589, 2176, 2366, 1827, 2091, 2400, 2033, 7320, 5338, 4440, 1328, 1492, 4928, 8226, 2148, 3634, 4186, 3642, 4428, 148).map(x => x.toDouble)))
    val dataRawNorm = normalizerForTests(dataRaw)
    val data = sc.parallelize(dataRawNorm)
    smarterDivergence(data, testedWordNorm, List(20.0, 20.0, 30.0)).collect().sortWith(_ < _) should be(Array("nucléaire", "nationales"))
  }


}